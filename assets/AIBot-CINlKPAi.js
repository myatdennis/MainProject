var Y=Object.defineProperty,Q=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var q=(l,e,s)=>e in l?Y(l,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[e]=s,b=(l,e)=>{for(var s in e||(e={}))ee.call(e,s)&&q(l,s,e[s]);if(_)for(var s of _(e))te.call(e,s)&&q(l,s,e[s]);return l},v=(l,e)=>Q(l,Z(e));var y=(l,e,s)=>new Promise((r,o)=>{var i=n=>{try{c(s.next(n))}catch(m){o(m)}},h=n=>{try{c(s.throw(n))}catch(m){o(m)}},c=n=>n.done?r(n.value):Promise.resolve(n.value).then(i,h);c((s=s.apply(l,e)).next())});import{r as u,aF as se,j as t,ad as ae,ai as ie,bm as R,bn as re,bo as ne,ba as oe,X as ce,x as le,at as de}from"./vendor-react-DvkU9ZSQ.js";import{s as ue}from"./admin-secondary-BDE6J84T.js";import{g as he}from"./admin-surveys-C61jzNMV.js";import{u as me}from"./org-workspace-uEdDnMAX.js";import"./supabase-CqkleIqs.js";import"./vendor-Dox2Yl3q.js";import"./vendor-react-dom-Dki47u2n.js";import"./admin-courses-Othof8Q0.js";class pe{constructor(){this.cache=new Map,this.inFlight=new Map,this.cacheTtlMs=5*60*1e3,this.maxRequestsPerWindow=6,this.windowSizeMs=15e3,this.recentRequestTimestamps=[],this.prohibitedPatterns=[/\bself\s*harm\b/i,/\bviolence\b/i,/\bhate\s*speech\b/i]}getAssistantReply(e){return y(this,null,function*(){this.guardPrompt(e.prompt),this.enforceRateLimit();const s=this.createCacheKey("assistant",e),r=this.cache.get(s);if(r&&r.expiresAt>Date.now())return v(b({},r.value),{metadata:v(b({},r.value.metadata),{source:"cache"})});if(this.inFlight.has(s))return this.inFlight.get(s);const o=this.resolveAssistantReply(e,s).then(i=>(this.cache.set(s,{expiresAt:Date.now()+this.cacheTtlMs,value:i}),i)).finally(()=>this.inFlight.delete(s));return this.inFlight.set(s,o),o})}generateCourseOutline(e){return y(this,null,function*(){this.guardPrompt(e.topic),this.enforceRateLimit();const s=this.createCacheKey("course-outline",e),r=this.cache.get(s);if(r&&r.expiresAt>Date.now())return v(b({},r.value),{metadata:v(b({},r.value.metadata),{source:"cache"})});if(this.inFlight.has(s))return this.inFlight.get(s);const o=this.buildCourseOutline(e,s).then(i=>(this.cache.set(s,{expiresAt:Date.now()+this.cacheTtlMs,value:i}),i)).finally(()=>this.inFlight.delete(s));return this.inFlight.set(s,o),o})}summarizeSurveyInsights(e,s){return y(this,null,function*(){var n,m,g;const r=this.createCacheKey("survey-summary",{surveyId:e.id,organizationId:s}),o=this.cache.get(r);if(o&&o.expiresAt>Date.now())return v(b({},o.value),{metadata:v(b({},o.value.metadata),{source:"cache"})});const i=yield he(e.id,s),h=Array.isArray(i==null?void 0:i.insights)&&i.insights.length>0?i.insights:["Collect more responses to unlock AI-assisted insights."],c={message:`Here is the latest intelligence for **${e.title}**:

- Total responses: ${(n=i==null?void 0:i.totalResponses)!=null?n:0}
- Completion rate: ${(m=i==null?void 0:i.completionRate)!=null?m:0}%
- Avg. completion time: ${(g=i==null?void 0:i.avgCompletionTime)!=null?g:0} minutes

Key insights:
${h.map(p=>`• ${p}`).join(`
`)}`,suggestions:["View detailed survey analytics","Share a summary with stakeholders","Schedule a listening session with low-scoring teams"],metadata:{source:"generated",cacheKey:r,generatedAt:new Date().toISOString()}};return this.cache.set(r,{expiresAt:Date.now()+this.cacheTtlMs,value:c}),c})}resolveAssistantReply(e,s){return y(this,null,function*(){const r=e.prompt.trim().toLowerCase(),o=new Date().toISOString();if(r.includes("outline")||r.includes("curriculum"))return this.buildCourseOutline({topic:e.prompt,audience:e.route==="lms"?"learner":"admin",organizationId:e.organizationId},s);if(r.includes("completion rate")||r.includes("progress")){const h=yield this.fetchCourseSignals(e.organizationId),c=["Open the analytics dashboard","Send nudges to learners who are behind","Review struggling lessons for updates"],n=h.slice(0,3).map(g=>`${g.courseId} (${g.completions} completions)`).join(", ");return{message:h.length>0?`Based on the latest completions, the top-performing courses are ${n}. Consider boosting support for modules with higher drop-offs.`:"I do not have recent completions yet. Once learners begin finishing courses, I will surface the trends here.",suggestions:c,metadata:{source:"generated",cacheKey:s,generatedAt:o}}}const i=e.route==="admin"?["Review organization health dashboard","Assign a new learning path","Export a stakeholder-ready report"]:e.route==="lms"?["Show my course progress","Suggest a quick practice activity","Explain a key concept"]:["Schedule a discovery call","Explore success stories","Share pricing options"];return{message:this.buildFriendlyResponse(e.prompt,e.route),suggestions:i,metadata:{source:"generated",cacheKey:s,generatedAt:o}}})}buildCourseOutline(e,s){return y(this,null,function*(){var g;const r=new Date().toISOString(),o=e.topic.trim(),i=e.outcomes&&e.outcomes.length>0?e.outcomes:["Understand the core concepts","Apply strategies in real scenarios","Measure impact effectively"],c=(g=(yield this.fetchCourseSignals(e.organizationId)).find(p=>p.dropOffRate>30))==null?void 0:g.courseId,n=[{title:`Foundations of ${o}`,description:`Establish shared language and expectations for ${o.toLowerCase()}.`,actions:["Context-setting micro-lecture","Reflection prompt","Pulse-check poll"]},{title:`Practice ${o} with Real Scenarios`,description:"Apply the concepts to lived examples and interactive case studies.",actions:["Scenario lab","Peer discussion","Progress assessment"]},{title:`Sustain and Measure ${o}`,description:"Embed rituals, metrics, and accountability plans to sustain progress.",actions:["Action planning","Measurement toolkit","Executive summary"]}],m=c?`Learners most often pause in **${c}**, so add facilitator guidance or office hours there.`:"Learners maintain momentum through the flow; sustain with quick reflection prompts.";return{message:`Here is a three-part outline for **${o}** tailored to ${e.audience} audiences:

${n.map((p,S)=>`**Module ${S+1}: ${p.title}**
${p.description}
Key activities: ${p.actions.join(", ")}`).join(`

`)}

Intended outcomes:
${i.map(p=>`• ${p}`).join(`
`)}

${m}`,suggestions:["Export as a course draft","Generate facilitator notes","Design an assessment for this outline"],metadata:{source:"generated",cacheKey:s,generatedAt:r}}})}fetchCourseSignals(e){return y(this,null,function*(){return[]})}guardPrompt(e){if(e){for(const s of this.prohibitedPatterns)if(s.test(e))throw new Error("The requested prompt cannot be processed because it violates safety guardrails.")}}enforceRateLimit(){const e=Date.now();for(this.recentRequestTimestamps.push(e);this.recentRequestTimestamps.length&&e-this.recentRequestTimestamps[0]>this.windowSizeMs;)this.recentRequestTimestamps.shift();if(this.recentRequestTimestamps.length>this.maxRequestsPerWindow)throw new Error("Please slow down a bit — the assistant needs a moment before handling more requests.")}createCacheKey(e,s){return`${e}:${JSON.stringify(s)}`}buildFriendlyResponse(e,s){return s==="admin"?`I'll help you operationalize that. ${e.includes("report")?"You can export a ready-to-share PDF from the analytics screen.":"Let me know which organization or cohort you want to focus on, and I will surface the right metrics."}`:s==="lms"?`Great question! I can point you to the right lesson or resource. Ask for a refresher, a practice scenario, or a quick summary for "${e}".`:"I'd love to help you explore The Huddle Co.'s services. Share a bit more about your goals and I can recommend programs or next steps."}}const ge=new pe,H='button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])',C=l=>l.replace(/[\*_`>#]/g,""),Ie=()=>{const{user:l}=me(),[e,s]=u.useState(!1),[r,o]=u.useState(!1),[i,h]=u.useState(""),[c,n]=u.useState([]),[m,g]=u.useState(!1),[p,S]=u.useState(null),[W,N]=u.useState(""),$=u.useRef(null),E=u.useRef(null),M=u.useRef(null),D=se(),[T,B]=u.useState(!1),I=D.pathname.startsWith("/admin"),A=D.pathname.startsWith("/lms"),G=I?"admin":A?"lms":"marketing",z="ai-assistant-title",F="ai-assistant-description",U=()=>{var a;(a=$.current)==null||a.scrollIntoView({behavior:"smooth"})};u.useEffect(()=>{U()},[c]),u.useEffect(()=>{const a=d=>{d.altKey&&d.shiftKey&&d.key.toLowerCase()==="a"&&(d.preventDefault(),s(f=>!f),o(!1))};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[]),u.useEffect(()=>{var j;if(!e){(j=M.current)==null||j.focus();return}const a=E.current;if(!a)return;(()=>{var w;(w=a.querySelectorAll(H)[0])==null||w.focus()})();const f=x=>{if(x.key==="Escape"){s(!1);return}if(x.key!=="Tab")return;const w=a.querySelectorAll(H);if(w.length===0){x.preventDefault();return}const P=w[0],K=w[w.length-1],k=document.activeElement;x.shiftKey?(k===P||!a.contains(k))&&(x.preventDefault(),K.focus()):k===K&&(x.preventDefault(),P.focus())};return a.addEventListener("keydown",f),()=>a.removeEventListener("keydown",f)},[e,r]),u.useEffect(()=>{if(e&&c.length===0){const a=L();n([{id:"welcome",type:"bot",content:a.message,timestamp:new Date,suggestions:a.suggestions}]),N(C(a.message))}},[e,I,A]),u.useEffect(()=>{c.length>50&&n(a=>a.slice(a.length-50))},[c]);const L=()=>I?{message:"Hi Mya! I'm your AI assistant for The Huddle Co. admin portal. I can help with analytics, user management, course insights, and more. What would you like to know?",suggestions:["Show me users at risk of dropping out","What's our completion rate this month?","Which modules need improvement?","Generate a progress report"]}:A?{message:"Hello! I'm here to support your learning journey. I can answer questions about course content, provide study tips, remind you of deadlines, and suggest next steps. How can I assist you today?",suggestions:["What should I focus on next?","Explain inclusive leadership principles","How do I handle difficult conversations?","Show my progress summary"]}:{message:"Welcome to The Huddle Co.! I'm here to help you learn about our DEI consulting services, training programs, and how we can support your organization. What would you like to know?",suggestions:["Tell me about your services","How does the training work?","What results do clients see?","Schedule a discovery call"]},O=()=>y(void 0,null,function*(){if(!i.trim())return;const a={id:Date.now().toString(),type:"user",content:i,timestamp:new Date};n(d=>[...d,a]),h(""),g(!0),S(null);try{const d=yield ge.getAssistantReply({prompt:a.content,route:G,organizationId:void 0,userId:l==null?void 0:l.id}),f={id:`${Date.now()}-bot`,type:"bot",content:d.message,timestamp:new Date,suggestions:d.suggestions};n(j=>[...j,f]),N(C(d.message))}catch(d){const f=d instanceof Error?d.message:"I ran into an issue while generating a response. Please try again.",j={id:`${Date.now()}-error`,type:"bot",content:f,timestamp:new Date};n(x=>[...x,j]),S(f),N(C(f))}finally{g(!1)}}),V=a=>{h(a)},J=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),O())},X=()=>{n([]);const a=L();n([{id:"welcome",type:"bot",content:a.message,timestamp:new Date,suggestions:a.suggestions}]),N(C(a.message)),S(null)};return e?t.jsxs("div",{ref:E,id:"ai-assistant-panel",role:"dialog","aria-modal":"true","aria-labelledby":z,"aria-describedby":F,className:`fixed bottom-6 right-6 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 transition-all duration-300 ${r?"w-80 h-16":"w-96 h-[600px]"}`,children:[t.jsx("p",{id:F,className:"sr-only",children:"Conversational assistant with keyboard navigation and accessible controls. Press Escape to close."}),t.jsx("div",{className:"sr-only","aria-live":"polite",children:W}),t.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-red-50 rounded-t-2xl",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"bg-gradient-to-r from-orange-400 to-red-500 p-2 rounded-full",children:t.jsx(R,{className:"h-5 w-5 text-white","aria-hidden":"true"})}),t.jsxs("div",{children:[t.jsx("h3",{id:z,className:"font-bold text-gray-900",children:"AI Assistant"}),t.jsx("p",{className:"text-xs text-gray-600",children:I?"Admin Support":A?"Learning Coach":"The Huddle Co."})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("button",{onClick:()=>o(!r),className:"p-1 text-gray-400 hover:text-gray-600 rounded","aria-label":r?"Expand assistant":"Minimize assistant",children:r?t.jsx(re,{className:"h-4 w-4"}):t.jsx(ne,{className:"h-4 w-4"})}),t.jsx("button",{onClick:X,className:"p-1 text-gray-400 hover:text-gray-600 rounded","aria-label":"Clear conversation",children:t.jsx(oe,{className:"h-4 w-4"})}),t.jsx("button",{onClick:()=>s(!1),className:"p-1 text-gray-400 hover:text-gray-600 rounded","aria-label":"Close assistant",children:t.jsx(ce,{className:"h-4 w-4"})})]})]}),!r&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 h-96","aria-live":"polite",children:[c.map(a=>t.jsx("div",{className:`flex ${a.type==="user"?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`flex items-start space-x-2 max-w-[80%] ${a.type==="user"?"flex-row-reverse space-x-reverse":""}`,children:[t.jsx("div",{className:`p-2 rounded-full ${a.type==="user"?"bg-orange-500":"bg-gray-100"}`,"aria-hidden":"true",children:a.type==="user"?t.jsx(le,{className:"h-4 w-4 text-white"}):t.jsx(R,{className:"h-4 w-4 text-gray-500"})}),t.jsxs("div",{className:`rounded-2xl px-4 py-3 shadow-sm ${a.type==="user"?"bg-gradient-to-r from-orange-500 to-red-500 text-white":"bg-white border border-gray-200 text-gray-900"}`,children:[t.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-line",children:a.content}),a.suggestions&&a.suggestions.length>0&&t.jsx("div",{className:"mt-2 space-x-2 space-y-2",children:a.suggestions.map(d=>t.jsx("button",{onClick:()=>V(d),className:`inline-flex items-center text-xs px-3 py-1 rounded-full transition-colors border ${a.type==="user"?"border-white/80 text-white bg-white/10 hover:bg-white/20":"border-orange-100 text-orange-600 bg-orange-50 hover:bg-orange-100"}`,children:d},d))}),t.jsx("div",{className:"mt-2 text-[10px] uppercase tracking-wide opacity-70",children:a.timestamp.toLocaleTimeString()})]})]})},a.id)),m&&t.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500","aria-live":"assertive",children:[t.jsx(R,{className:"h-4 w-4","aria-hidden":"true"}),t.jsx("span",{children:"Thinking…"})]}),t.jsx("div",{ref:$})]}),p&&t.jsx("div",{className:"px-4 text-xs text-red-600",role:"status",children:p}),t.jsxs("div",{className:"p-4 border-t border-gray-100 bg-white space-y-2",children:[t.jsx("label",{htmlFor:"ai-assistant-input",className:"sr-only",children:"Ask the AI assistant"}),t.jsx("textarea",{id:"ai-assistant-input",className:"w-full h-24 resize-none rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent px-3 py-2 text-sm",placeholder:"Ask me for analytics, learning support, or platform guidance...",value:i,onChange:a=>h(a.target.value),onKeyDown:J,"aria-label":"Message the AI assistant"}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-[11px] text-gray-500",children:"Tip: Press Enter to send, Shift + Enter for a new line."}),t.jsxs("button",{onClick:O,className:"inline-flex items-center space-x-2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-full shadow-lg hover:from-orange-600 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2","aria-label":"Send message",children:[t.jsx("span",{children:"Send"}),t.jsx(de,{className:"h-4 w-4"})]})]})]})]})]}):t.jsxs("div",{className:"fixed bottom-6 right-6 z-50 flex flex-col items-end space-y-2",children:[t.jsx("button",{onClick:()=>B(a=>!a),className:"bg-yellow-400 text-white p-3 rounded-full shadow-lg",title:"Tips & Shortcuts","aria-expanded":T,"aria-controls":"ai-assistant-tips",children:t.jsx(ae,{className:"h-6 w-6"})}),t.jsx("button",{ref:M,onClick:()=>s(!0),className:"bg-gradient-to-r from-orange-400 to-red-500 text-white p-4 rounded-full shadow-lg hover:from-orange-500 hover:to-red-600 transition-all duration-200 transform hover:scale-110",title:"Open AI Assistant","aria-haspopup":"dialog","aria-expanded":!1,"aria-controls":"ai-assistant-panel",children:t.jsx(ie,{className:"h-6 w-6"})}),T&&t.jsxs("div",{id:"ai-assistant-tips",className:"mt-2 w-64 bg-white rounded-lg shadow-lg p-3 border border-gray-200 text-sm text-gray-700",children:[t.jsx("div",{className:"font-semibold mb-1",children:"AI Tips"}),t.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[t.jsx("li",{children:"Press Alt + Shift + A to toggle the assistant anywhere."}),t.jsx("li",{children:"Ask for completion trends or intervention lists."}),t.jsx("li",{children:'Say "export report" to prepare summaries.'})]})]})]})};export{Ie as default};
