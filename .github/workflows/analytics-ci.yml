name: Analytics migration & seed

on:
  workflow_dispatch:

jobs:
  migrate-and-seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install libpq (psql)
        run: sudo apt-get update && sudo apt-get install -y libpq-dev postgresql-client

      - name: Run migration
        env:
          DATABASE_URL: ${{ secrets.ANALYTICS_DATABASE_URL }}
        run: |
          sh ./scripts/run_migration.sh supabase/migrations/20251108_add_analytics_tables_and_views.sql

      - name: Seed analytics data
        env:
          DATABASE_URL: ${{ secrets.ANALYTICS_DATABASE_URL }}
        run: |
          node ./scripts/seed_analytics.js
