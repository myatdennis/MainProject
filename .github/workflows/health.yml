name: health-monitor

on:
  schedule:
    - cron: '*/30 * * * *' # every 30 minutes
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Curl domain root
        run: |
          DOMAIN=${DOMAIN:-the-huddle.co}
          curl -fsS https://$DOMAIN/ | head -c 200 || exit 1
      - name: API health (Supabase Edge function proxy)
        run: |
          set -euo pipefail
          URL="https://mainproject-production-4e66.up.railway.app"
          if curl -fsS "$URL/api/health" | jq -e '.ok == true' >/dev/null; then
            echo "API health endpoint responded OK"
          else
            echo "/api/health failed, retrying /health â€¦"
            curl -fsS "$URL/health" | jq -e '.ok == true' >/dev/null
          fi
      - name: CORS preflight
        run: |
          API_HOST=${API_HOST:-miqzywzuqzeffqpiupjm.supabase.co}
          DOMAIN=${DOMAIN:-the-huddle.co}
          curl -i -X OPTIONS https://$API_HOST/functions/v1/api/auth/login -H "Origin: https://$DOMAIN" -H "Access-Control-Request-Method: POST" | grep -i "Access-Control-Allow-Origin" || exit 1
